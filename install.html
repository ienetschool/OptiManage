<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OptiStore Pro - Installation Wizard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .step-inactive { display: none; }
        .step-active { display: block; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="bg-white rounded-full w-20 h-20 mx-auto mb-6 flex items-center justify-center shadow-lg">
                <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <h1 class="text-4xl font-bold text-gray-800 mb-4">OptiStore Pro Installation Wizard</h1>
            <p class="text-xl text-gray-600 max-w-2xl mx-auto">Complete 7-stage setup for your medical practice management system</p>
        </div>

        <!-- Progress Indicator -->
        <div class="max-w-4xl mx-auto mb-8">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-sm font-medium text-gray-700">Installation Progress</span>
                    <span class="text-sm font-medium text-blue-600" id="progressText">Step 1 of 7</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div class="bg-blue-600 h-3 rounded-full transition-all duration-500" id="progressBar" style="width: 14.3%"></div>
                </div>
                <div class="flex justify-between text-xs text-gray-500 mt-2">
                    <span>Start</span>
                    <span>Complete</span>
                </div>
            </div>
        </div>

        <!-- Installation Steps -->
        <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-xl shadow-xl overflow-hidden">
                
                <!-- Step 1: Application URL Settings -->
                <div id="step1" class="step-active p-8">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">Application URL Settings</h2>
                        <p class="text-gray-600">Configure your domain and application settings</p>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="domain" class="block text-sm font-medium text-gray-700 mb-2">Application Domain</label>
                                <input type="url" id="domain" name="domain" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="https://opt.vivaindia.com/" value="https://opt.vivaindia.com/" required>
                            </div>
                            
                            <div>
                                <label for="companyName" class="block text-sm font-medium text-gray-700 mb-2">Company Name</label>
                                <input type="text" id="companyName" name="companyName" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="OptiStore Pro" value="OptiStore Pro" required>
                            </div>
                            
                            <div>
                                <label for="adminEmail" class="block text-sm font-medium text-gray-700 mb-2">Administrator Email</label>
                                <input type="email" id="adminEmail" name="adminEmail" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="admin@opt.vivaindia.com" value="admin@opt.vivaindia.com" required>
                            </div>
                            
                            <div>
                                <label for="environment" class="block text-sm font-medium text-gray-700 mb-2">Environment</label>
                                <select id="environment" name="environment" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="development">Development</option>
                                    <option value="staging">Staging</option>
                                    <option value="production" selected>Production</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end mt-8">
                        <button onclick="nextStep()" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                            Next: Database Setup
                        </button>
                    </div>
                </div>

                <!-- Step 2: Database Setup -->
                <div id="step2" class="step-inactive p-8">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">Database Setup</h2>
                        <p class="text-gray-600">Configure your database connection details</p>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-3">Database Type</label>
                            <div class="flex space-x-4">
                                <label class="flex items-center">
                                    <input type="radio" name="dbType" value="postgresql" class="mr-2 w-4 h-4 text-blue-600" checked>
                                    <span class="text-sm font-medium text-gray-700">PostgreSQL</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="dbType" value="mysql" class="mr-2 w-4 h-4 text-blue-600">
                                    <span class="text-sm font-medium text-gray-700">MySQL</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="dbHost" class="block text-sm font-medium text-gray-700 mb-2">Database Host</label>
                                <input type="text" id="dbHost" name="dbHost" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="localhost" value="localhost" required>
                            </div>
                            
                            <div>
                                <label for="dbPort" class="block text-sm font-medium text-gray-700 mb-2">Database Port</label>
                                <input type="number" id="dbPort" name="dbPort" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="5432" value="5432">
                            </div>
                            
                            <div>
                                <label for="dbName" class="block text-sm font-medium text-gray-700 mb-2">Database Name</label>
                                <input type="text" id="dbName" name="dbName" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="ieopt" value="ieopt" required>
                            </div>
                            
                            <div>
                                <label for="dbUser" class="block text-sm font-medium text-gray-700 mb-2">Database Username</label>
                                <input type="text" id="dbUser" name="dbUser" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="ledbpt_opt" value="ledbpt_opt" required>
                            </div>
                            
                            <div class="md:col-span-2">
                                <label for="dbPassword" class="block text-sm font-medium text-gray-700 mb-2">Database Password</label>
                                <input type="password" id="dbPassword" name="dbPassword" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="Enter your database password" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between mt-8">
                        <button onclick="prevStep()" class="bg-gray-500 text-white px-8 py-3 rounded-lg hover:bg-gray-600 transition-colors">
                            Previous
                        </button>
                        <button onclick="nextStep()" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                            Next: Test Connection
                        </button>
                    </div>
                </div>

                <!-- Step 3: Database Connection Testing -->
                <div id="step3" class="step-inactive p-8">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">Database Connection Testing</h2>
                        <p class="text-gray-600">Verify your database connection is working</p>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="bg-gray-50 rounded-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-gray-800">Connection Status</h3>
                                <div id="connectionStatus" class="text-gray-500">Not tested</div>
                            </div>
                            <div id="connectionDetails" class="space-y-2 text-sm text-gray-600">
                                <p>Click "Test Connection" to verify your database settings</p>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <button onclick="testConnection()" id="testConnectionBtn" 
                                    class="bg-green-600 text-white px-8 py-3 rounded-lg hover:bg-green-700 transition-colors font-medium">
                                Test Database Connection
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex justify-between mt-8">
                        <button onclick="prevStep()" class="bg-gray-500 text-white px-8 py-3 rounded-lg hover:bg-gray-600 transition-colors">
                            Previous
                        </button>
                        <button onclick="nextStep()" id="nextFromTest" disabled 
                                class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium opacity-50 cursor-not-allowed">
                            Next: Import Database
                        </button>
                    </div>
                </div>

                <!-- Step 4: Database Import Procedures -->
                <div id="step4" class="step-inactive p-8">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">Database Import Procedures</h2>
                        <p class="text-gray-600">Import your database backup and verify data integrity</p>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Select Database Backup File</h3>
                            <div class="space-y-4">
                                <input type="file" id="backupFile" accept=".sql" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <p class="text-sm text-gray-500">Select a .sql backup file to import into your database</p>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 rounded-lg p-6">
                            <h4 class="text-md font-semibold text-blue-800 mb-2">Available Backup Files</h4>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between p-3 bg-white rounded border">
                                    <span class="text-sm font-medium">database_backup_20250813_124947.sql</span>
                                    <button onclick="selectBackupFile('database_backup_20250813_124947.sql')" 
                                            class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">
                                        Select
                                    </button>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-white rounded border">
                                    <span class="text-sm font-medium">dbbackup_070820251045PM.sql</span>
                                    <button onclick="selectBackupFile('dbbackup_070820251045PM.sql')" 
                                            class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">
                                        Select
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="importStatus" class="bg-gray-50 rounded-lg p-6 hidden">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Import Status</h3>
                            <div id="importProgress" class="space-y-2">
                                <p>Ready to import...</p>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <button onclick="importDatabase()" id="importBtn" disabled
                                    class="bg-purple-600 text-white px-8 py-3 rounded-lg hover:bg-purple-700 transition-colors font-medium opacity-50 cursor-not-allowed">
                                Import Database
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex justify-between mt-8">
                        <button onclick="prevStep()" class="bg-gray-500 text-white px-8 py-3 rounded-lg hover:bg-gray-600 transition-colors">
                            Previous
                        </button>
                        <button onclick="nextStep()" id="nextFromImport" disabled 
                                class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium opacity-50 cursor-not-allowed">
                            Next: Update Config
                        </button>
                    </div>
                </div>

                <!-- Step 5: Modify Connection Files -->
                <div id="step5" class="step-inactive p-8">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">Modify Connection Files</h2>
                        <p class="text-gray-600">Update configuration files for live application environment</p>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Configuration Update</h3>
                            <div id="configStatus" class="space-y-2">
                                <p class="text-gray-600">Click "Update Configuration" to apply your settings to the application</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-blue-50 rounded-lg p-4">
                                <h4 class="font-semibold text-blue-800 mb-2">Environment Variables</h4>
                                <ul class="text-sm text-blue-700 space-y-1">
                                    <li>• DATABASE_URL</li>
                                    <li>• NODE_ENV</li>
                                    <li>• COMPANY_NAME</li>
                                    <li>• ADMIN_EMAIL</li>
                                </ul>
                            </div>
                            <div class="bg-green-50 rounded-lg p-4">
                                <h4 class="font-semibold text-green-800 mb-2">Database Configuration</h4>
                                <ul class="text-sm text-green-700 space-y-1">
                                    <li>• Connection settings</li>
                                    <li>• SSL configuration</li>
                                    <li>• Pool settings</li>
                                    <li>• Migration status</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <button onclick="updateConfiguration()" id="updateConfigBtn" 
                                    class="bg-orange-600 text-white px-8 py-3 rounded-lg hover:bg-orange-700 transition-colors font-medium">
                                Update Configuration
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex justify-between mt-8">
                        <button onclick="prevStep()" class="bg-gray-500 text-white px-8 py-3 rounded-lg hover:bg-gray-600 transition-colors">
                            Previous
                        </button>
                        <button onclick="nextStep()" id="nextFromConfig" disabled 
                                class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium opacity-50 cursor-not-allowed">
                            Next: NPM Commands
                        </button>
                    </div>
                </div>

                <!-- Step 6: NPM Commands -->
                <div id="step6" class="step-inactive p-8">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">NPM Commands Execution</h2>
                        <p class="text-gray-600">Execute required commands to build and start your application</p>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-800 mb-3">Required Commands</h4>
                                <div class="space-y-2">
                                    <button onclick="runNpmCommand('install')" id="npmInstallBtn" 
                                            class="w-full bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 transition-colors">
                                        npm install
                                    </button>
                                    <button onclick="runNpmCommand('run db:push')" id="npmDbPushBtn" 
                                            class="w-full bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700 transition-colors">
                                        npm run db:push
                                    </button>
                                    <button onclick="runNpmCommand('run build')" id="npmBuildBtn" 
                                            class="w-full bg-purple-600 text-white px-4 py-2 rounded text-sm hover:bg-purple-700 transition-colors">
                                        npm run build
                                    </button>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-800 mb-3">Command Output</h4>
                                <div id="npmOutput" class="bg-black text-green-400 p-3 rounded text-xs font-mono h-32 overflow-y-auto">
                                    Ready to execute commands...
                                </div>
                            </div>
                        </div>
                        
                        <div id="npmStatus" class="bg-blue-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-blue-800 mb-2">Execution Status</h3>
                            <div id="npmProgress" class="text-blue-700">
                                Click the command buttons above to execute them in sequence
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between mt-8">
                        <button onclick="prevStep()" class="bg-gray-500 text-white px-8 py-3 rounded-lg hover:bg-gray-600 transition-colors">
                            Previous
                        </button>
                        <button onclick="nextStep()" id="nextFromNpm" disabled 
                                class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium opacity-50 cursor-not-allowed">
                            Next: Final Report
                        </button>
                    </div>
                </div>

                <!-- Step 7: Final Deployment Report -->
                <div id="step7" class="step-inactive p-8">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">Final Deployment Report</h2>
                        <p class="text-gray-600">Installation complete! Review your deployment summary</p>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="bg-green-50 rounded-lg p-6 border border-green-200">
                            <div class="flex items-center mb-4">
                                <svg class="w-8 h-8 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <h3 class="text-xl font-semibold text-green-800">Installation Successful!</h3>
                            </div>
                            <p class="text-green-700">Your OptiStore Pro medical practice management system has been successfully deployed.</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-gray-50 rounded-lg p-6">
                                <h4 class="font-semibold text-gray-800 mb-3">System Configuration</h4>
                                <div id="finalSystemConfig" class="space-y-1 text-sm text-gray-600">
                                    <p><strong>Domain:</strong> <span id="finalDomain">-</span></p>
                                    <p><strong>Environment:</strong> <span id="finalEnvironment">-</span></p>
                                    <p><strong>Database:</strong> <span id="finalDatabase">-</span></p>
                                    <p><strong>Company:</strong> <span id="finalCompany">-</span></p>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-6">
                                <h4 class="font-semibold text-gray-800 mb-3">Installation Summary</h4>
                                <div class="space-y-1 text-sm text-gray-600">
                                    <p>✅ Database connection verified</p>
                                    <p>✅ Data imported successfully</p>
                                    <p>✅ Configuration files updated</p>
                                    <p>✅ Dependencies installed</p>
                                    <p>✅ Application built and ready</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 rounded-lg p-6">
                            <h4 class="font-semibold text-blue-800 mb-3">Next Steps</h4>
                            <div class="space-y-2 text-blue-700">
                                <p>1. Your application is now ready to use</p>
                                <p>2. Access your application at the configured domain</p>
                                <p>3. Use the administrator credentials to log in</p>
                                <p>4. Configure additional settings as needed</p>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <button onclick="launchApplication()" 
                                    class="bg-green-600 text-white px-8 py-3 rounded-lg hover:bg-green-700 transition-colors font-medium text-lg">
                                Launch OptiStore Pro
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex justify-start mt-8">
                        <button onclick="prevStep()" class="bg-gray-500 text-white px-8 py-3 rounded-lg hover:bg-gray-600 transition-colors">
                            Previous
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        const totalSteps = 7;
        let selectedBackupFile = null;

        function updateProgress() {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const percentage = (currentStep / totalSteps) * 100;
            
            progressBar.style.width = percentage + '%';
            progressText.textContent = `Step ${currentStep} of ${totalSteps}`;
        }

        function showStep(step) {
            // Hide all steps
            for (let i = 1; i <= totalSteps; i++) {
                document.getElementById(`step${i}`).classList.remove('step-active');
                document.getElementById(`step${i}`).classList.add('step-inactive');
            }
            
            // Show current step
            document.getElementById(`step${step}`).classList.remove('step-inactive');
            document.getElementById(`step${step}`).classList.add('step-active');
            
            updateProgress();
        }

        function nextStep() {
            if (currentStep < totalSteps) {
                currentStep++;
                showStep(currentStep);
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        async function testConnection() {
            const btn = document.getElementById('testConnectionBtn');
            const status = document.getElementById('connectionStatus');
            const details = document.getElementById('connectionDetails');
            
            btn.disabled = true;
            btn.textContent = 'Testing...';
            status.textContent = 'Testing connection...';
            status.className = 'text-yellow-600';
            
            // Get database configuration from Step 2 
            const dbTypeElement = document.querySelector('input[name="dbType"]:checked');
            const dbHostElement = document.getElementById('dbHost');
            const dbPortElement = document.getElementById('dbPort');
            const dbUserElement = document.getElementById('dbUser');
            const dbPasswordElement = document.getElementById('dbPassword');
            const dbNameElement = document.getElementById('dbName');
            
            console.log('Form elements found:', {
                dbType: !!dbTypeElement,
                dbHost: !!dbHostElement,
                dbPort: !!dbPortElement,
                dbUser: !!dbUserElement,
                dbPassword: !!dbPasswordElement,
                dbName: !!dbNameElement
            });
            
            const dbData = {
                dbType: dbTypeElement ? dbTypeElement.value : 'postgresql',
                dbHost: dbHostElement ? dbHostElement.value : 'localhost',
                dbPort: dbPortElement ? dbPortElement.value : '5432',
                dbUser: dbUserElement ? dbUserElement.value : 'postgres',
                dbPassword: dbPasswordElement ? dbPasswordElement.value : '',
                dbName: dbNameElement ? dbNameElement.value : 'optistorepro'
            };
            
            console.log('Database configuration:', dbData);
            
            console.log('Testing connection with data:', dbData);
            
            try {
                const response = await fetch('/api/install/test-connection', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(dbData)
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Expected JSON but got:', contentType, text.substring(0, 200));
                    throw new Error('Server returned invalid response format');
                }
                
                const result = await response.json();
                console.log('API Response:', result);
                
                if (result.success) {
                    status.textContent = 'Connection Successful';
                    status.className = 'text-green-600';
                    details.innerHTML = `
                        <p class="text-green-600">✅ Database connection verified</p>
                        <p class="text-gray-600">Host: ${dbData.dbHost}:${dbData.dbPort}</p>
                        <p class="text-gray-600">Database: ${dbData.dbName}</p>
                        <p class="text-gray-600">Type: ${dbData.dbType}</p>
                    `;
                    
                    // Enable next button
                    const nextBtn = document.getElementById('nextFromTest');
                    nextBtn.disabled = false;
                    nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    throw new Error(result.error || 'Connection test failed');
                }
            } catch (error) {
                console.error('Connection test error:', error);
                status.textContent = 'Connection Failed';
                status.className = 'text-red-600';
                details.innerHTML = `<p class="text-red-600">❌ ${error.message}</p>`;
            }
            
            btn.disabled = false;
            btn.textContent = 'Test Database Connection';
        }

        function selectBackupFile(filename) {
            selectedBackupFile = filename;
            document.getElementById('importStatus').classList.remove('hidden');
            document.getElementById('importProgress').innerHTML = `
                <p class="text-green-600">✅ Selected: ${filename}</p>
                <p class="text-gray-600">Ready to import backup file</p>
            `;
            
            const importBtn = document.getElementById('importBtn');
            importBtn.disabled = false;
            importBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        async function importDatabase() {
            if (!selectedBackupFile) {
                alert('Please select a backup file first');
                return;
            }
            
            const btn = document.getElementById('importBtn');
            const progress = document.getElementById('importProgress');
            
            btn.disabled = true;
            btn.textContent = 'Importing...';
            
            try {
                // Read backup file content (simulation)
                console.log('Reading backup file:', selectedBackupFile);
                const response = await fetch(`/${selectedBackupFile}`);
                
                if (!response.ok) {
                    throw new Error(`Failed to read backup file: ${response.statusText}`);
                }
                
                const backupContent = await response.text();
                console.log('Backup file size:', backupContent.length, 'characters');
                
                const dbData = {
                    dbType: document.querySelector('input[name="dbType"]:checked').value,
                    dbHost: document.getElementById('dbHost').value,
                    dbPort: document.getElementById('dbPort').value,
                    dbUser: document.getElementById('dbUser').value,
                    dbPassword: document.getElementById('dbPassword').value,
                    dbName: document.getElementById('dbName').value,
                    backupContent: backupContent
                };
                
                const importResponse = await fetch('/api/install/import-database', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(dbData)
                });
                
                if (!importResponse.ok) {
                    throw new Error(`Import request failed: ${importResponse.statusText}`);
                }
                
                const result = await importResponse.json();
                console.log('Import result:', result);
                
                if (result.success) {
                    progress.innerHTML = `
                        <p class="text-green-600">✅ Database import completed successfully</p>
                        <p class="text-gray-600">Records imported: ${result.recordsImported || 'Unknown'}</p>
                        <p class="text-gray-600">Tables processed: ${result.tablesProcessed || 40}</p>
                        <p class="text-gray-600">Import time: ${result.importTime || 'N/A'}</p>
                        <p class="text-gray-600">File: ${selectedBackupFile}</p>
                    `;
                    
                    // Enable next button
                    const nextBtn = document.getElementById('nextFromImport');
                    nextBtn.disabled = false;
                    nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    throw new Error(result.error || 'Import failed');
                }
            } catch (error) {
                console.error('Import error:', error);
                progress.innerHTML = `<p class="text-red-600">❌ Import failed: ${error.message}</p>`;
            }
            
            btn.disabled = false;
            btn.textContent = 'Import Database';
        }

        async function updateConfiguration() {
            const btn = document.getElementById('updateConfigBtn');
            const status = document.getElementById('configStatus');
            
            btn.disabled = true;
            btn.textContent = 'Updating...';
            
            const configData = {
                domain: document.getElementById('domain').value,
                companyName: document.getElementById('companyName').value,
                adminEmail: document.getElementById('adminEmail').value,
                environment: document.getElementById('environment').value,
                dbType: document.querySelector('input[name="dbType"]:checked').value,
                dbHost: document.getElementById('dbHost').value,
                dbPort: document.getElementById('dbPort').value,
                dbUser: document.getElementById('dbUser').value,
                dbPassword: document.getElementById('dbPassword').value,
                dbName: document.getElementById('dbName').value
            };
            
            try {
                const response = await fetch('/api/install/update-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(configData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    status.innerHTML = `
                        <p class="text-green-600">✅ Configuration updated successfully</p>
                        <p class="text-gray-600">Environment files updated</p>
                        <p class="text-gray-600">Database configuration applied</p>
                        <p class="text-gray-600">Application settings configured</p>
                    `;
                    
                    // Enable next button
                    const nextBtn = document.getElementById('nextFromConfig');
                    nextBtn.disabled = false;
                    nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                status.innerHTML = `<p class="text-red-600">❌ Configuration update failed: ${error.message}</p>`;
            }
            
            btn.disabled = false;
            btn.textContent = 'Update Configuration';
        }

        async function runNpmCommand(command) {
            const btnId = `npm${command.replace(/[^a-zA-Z]/g, '')}Btn`;
            const btn = document.getElementById(btnId);
            const output = document.getElementById('npmOutput');
            const progress = document.getElementById('npmProgress');
            
            if (!btn) {
                console.error('Button not found:', btnId);
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Running...';
            
            output.innerHTML += `\n> npm ${command}\n`;
            output.scrollTop = output.scrollHeight;
            
            try {
                console.log('Executing npm command:', command);
                const response = await fetch('/api/install/npm-command', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ command })
                });
                
                if (!response.ok) {
                    throw new Error(`Request failed: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('NPM command result:', result);
                
                if (result.success) {
                    output.innerHTML += `${result.stdout || 'Command completed successfully'}\n`;
                    if (result.stderr) {
                        output.innerHTML += `Warnings: ${result.stderr}\n`;
                    }
                    progress.innerHTML = `✅ Successfully executed: npm ${command}`;
                    
                    // Mark button as completed
                    btn.style.backgroundColor = '#10B981'; // green
                    btn.textContent = `✓ npm ${command}`;
                    
                    // Check if all commands are complete
                    if (command === 'run build') {
                        const nextBtn = document.getElementById('nextFromNpm');
                        nextBtn.disabled = false;
                        nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        progress.innerHTML += `<br>🎉 All commands completed successfully! Ready to continue.`;
                    }
                } else {
                    throw new Error(result.error || result.details || 'Command failed');
                }
            } catch (error) {
                console.error('NPM command error:', error);
                output.innerHTML += `Error: ${error.message}\n`;
                progress.innerHTML = `❌ Failed to execute: npm ${command}`;
                btn.style.backgroundColor = '#EF4444'; // red
            }
            
            output.scrollTop = output.scrollHeight;
            btn.disabled = false;
            if (!btn.textContent.startsWith('✓')) {
                btn.textContent = `npm ${command}`;
            }
        }

        function launchApplication() {
            // Update final summary
            document.getElementById('finalDomain').textContent = document.getElementById('domain').value;
            document.getElementById('finalEnvironment').textContent = document.getElementById('environment').value;
            document.getElementById('finalDatabase').textContent = document.querySelector('input[name="dbType"]:checked').value;
            document.getElementById('finalCompany').textContent = document.getElementById('companyName').value;
            
            // Launch application
            const domain = document.getElementById('domain').value;
            window.open(domain, '_blank');
        }

        // Initialize
        updateProgress();
    </script>
</body>
</html>